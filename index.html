<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vehicle Controller (Gemini Integrated)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&family=Montserrat:wght@300..700&display=swap" rel="stylesheet">
    <style>
        /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #0c0f16;
            color: #e0e6f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’è€ƒæ…®ã—ã¦ã‚µã‚¤ã‚ºè¨ˆç®— */
        }
        .container {
            width: 100%;
            max-width: 520px;
            background-color: #1a1e26;
            border-radius: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 255, 255, 0.15), 0 0 5px rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background-image: linear-gradient(to right, #00c6ff, #0072ff);
            color: white;
            padding: 1.5rem;
            text-align: center;
            border-bottom: 2px solid rgba(0, 255, 255, 0.5);
            position: relative;
        }
        .header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-shadow: 0 0 10px rgba(255,255,255,0.7);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒœãƒƒã‚¯ã‚¹ */
        .status-box { padding: 0.8rem 1rem; border-radius: 0.75rem; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; border: 1px solid transparent; transition: all 0.3s ease; }
        .status-icon { margin-right: 0.75rem; font-size: 1.2em; }
        .status-driving { background-color: #0f3d37; color: #66ffcc; border-color: #00ff99; box-shadow: 0 0 8px rgba(0, 255, 153, 0.4); }
        .status-pause { background-color: #4a3e0f; color: #ffe066; border-color: #ffcc00; box-shadow: 0 0 8px rgba(255, 204, 0, 0.4); }
        .status-wait { background-color: #1a2e4f; color: #99ccff; border-color: #3399ff; box-shadow: 0 0 8px rgba(51, 153, 255, 0.4); }
        .status-complete { background-color: #3a1a4a; color: #cc99ff; border-color: #9933ff; box-shadow: 0 0 8px rgba(153, 51, 255, 0.4); }
        .status-neutral { background-color: #23272f; color: #a0a8b4; border-color: #3f475a; display: block; }
        .command-log-content { display: block; max-height: 80px; overflow-y: auto; margin-top: 0.5rem; }
        .command-log-item { display: block; margin-bottom: 0.25rem; font-size: 0.85rem; }
        .log-error { color: #ff6b6b; }
        .log-success { color: #66ffcc; }
        .log-info { color: #99ccff; }

        /* AIãƒœã‚¿ãƒ³ (æ©Ÿèƒ½ãƒœã‚¿ãƒ³) */
        .ai-button {
            background-color: #6a1b9a; /* ç´« */
            color: white;
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: 0 4px 10px rgba(106, 27, 154, 0.4);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        .ai-button:hover {
            background-color: #8e24aa;
            box-shadow: 0 6px 15px rgba(142, 36, 170, 0.6);
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ (èµ·å‹•/ãƒ˜ãƒ«ãƒ—ãªã©) */
        .control-button {
            font-weight: bold;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }
        .control-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: #1a1e26;
            color: #e0e6f0;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            border: 2px solid #00c6ff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        .modal-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #00ffff;
            margin-bottom: 1rem;
            border-bottom: 1px solid #00ffff;
            padding-bottom: 0.5rem;
        }
        .help-section h3 {
            font-weight: bold;
            color: #66ffcc;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #66ffcc;
            padding-left: 0.5rem;
        }
        
        /* ã‚«ãƒ¡ãƒ©ã¨AIã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .camera-container {
            position: relative;
            width: 100%;
            padding-top: 75%; 
            overflow: hidden;
            background-color: #000;
            border-radius: 1rem;
            border: 2px solid #00c6ff;
            box-shadow: 0 0 15px rgba(0, 198, 255, 0.6);
            flex-shrink: 0;
        }
        #viewport {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; border-radius: 1rem;
        }
        #cameraFeed, #aiCanvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 1.0s ease-out;
        }
        #aiCanvas { pointer-events: none; }
        #aiOverlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; 
            padding: 1.25rem; text-shadow: 0 0 8px rgba(0,0,0,0.8); z-index: 10;
        }
        #aiDecisionText {
            font-family: 'Orbitron', sans-serif; font-size: 1.2rem; font-weight: bold; color: #00ffff;
            background-color: rgba(0, 0, 0, 0.7); padding: 0.6rem 1rem; border-radius: 0.75rem;
            align-self: center; margin-top: auto; border: 1px solid rgba(0, 255, 255, 0.5);
            pointer-events: auto; 
        }

        /* ã‚¿ãƒƒãƒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆç¸¦å‘ãã§ã‚‚è¦‹ãˆã‚‹ã‚ˆã†ã«å¸¸ã«å­˜åœ¨ï¼‰ */
        #touchControlOverlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; z-index: 15; 
            display: flex; flex-direction: column; pointer-events: none;
        }
        .touch-zone {
            flex-grow: 1; pointer-events: auto; user-select: none;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.9rem; font-weight: bold; color: rgba(255, 255, 255, 0.5);
            opacity: 0; transition: opacity 0.2s;
        }
        .touch-zone.active {
             opacity: 1; 
             color: #00ffff;
             background-color: rgba(0, 255, 255, 0.15);
             border: 2px solid #00ffff;
             text-shadow: 0 0 5px #00ffff;
        }
        #topZone { height: 35%; display: flex; flex-direction: row; }
        #bottomZone { height: 65%; display: flex; flex-direction: row; }
        
        /* æ—§ãƒ©ãƒ³ãƒ‰ã‚¹ã‚±ãƒ¼ãƒ—æœ€é©åŒ–CSSã‚’å‰Šé™¤ã—ã¾ã—ãŸ */
        
    </style>
</head>
<body>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« (Geminiç”¨ã¨Helpç”¨ã®å…±é€šæ§‹é€ ) -->
<div class="modal-overlay" id="geminiModal">
    <div class="modal-content">
        <h2 class="modal-title" id="modalTitle"></h2>
        <div id="modalBody" class="whitespace-pre-wrap text-sm leading-relaxed"></div>
        <button onclick="hideModal()" class="ai-button mt-6 bg-red-600 hover:bg-red-700">é–‰ã˜ã‚‹</button>
    </div>
</div>

<div class="container rounded-3xl shadow-2xl">
    <div class="header">
        <h1 class="text-2xl">Vehicle Controller</h1>
        <p class="text-sm">éšœå®³ç‰©å›é¿æ©Ÿèƒ½</p>
    </div>

    <!-- ã‚«ãƒ¡ãƒ©ãƒ•ã‚£ãƒ¼ãƒ‰ã¨AIã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="camera-container">
        <div id="viewport">
            <!-- å‹•ç”»è¦ç´  -->
            <video id="cameraFeed" autoplay playsinline></video>
            <!-- AIæç”»ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
            <canvas id="aiCanvas"></canvas> 
        </div>
        
        <!-- ã‚¿ãƒƒãƒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (AIãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã§æ‰‹å‹•æ“ä½œç”¨) -->
        <div id="touchControlOverlay">
            <div id="topZone">
                <div id="tl" class="touch-zone"></div> 
                <div id="tr" class="touch-zone"></div>
            </div>
            <div id="bottomZone">
                <div id="bl" class="touch-zone" data-command="TURN_L">å·¦æ—‹å›</div> 
                <div id="bc" class="touch-zone" data-command="FORWARD">ç›´é€²</div> 
                <div id="br" class="touch-zone" data-command="TURN_R">å³æ—‹å›</div>
            </div>
        </div>

        <!-- AI Decision Text (å¸¸ã«è¡¨ç¤º) -->
        <div id="aiOverlay">
            <span id="aiDecisionText">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦ãã ã•ã„</span>
        </div>
    </div>

    <!-- åˆ¶å¾¡ãƒ‘ãƒãƒ« (å¸¸ã«è¡¨ç¤º) -->
    <div id="controlPanel" class="w-full">
        <div class="p-5 border-t border-gray-700 mt-4">
            <h2 class="text-lg font-semibold mb-3 text-cyan-400">ã‚·ã‚¹ãƒ†ãƒ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
            <div class="flex flex-col space-y-3">
                <!-- Arduinoã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div id="arduinoStatus" class="status-box status-wait">
                    <span class="status-icon">â—</span> Arduino State: WAIT_START (å¾…æ©Ÿä¸­)
                </div>
                
                <!-- AIæ±ºå®šå‡ºåŠ› -->
                <div id="decisionOutput" class="status-box status-neutral flex justify-between items-center">
                    
                    <!-- Gemini æ©Ÿèƒ½ 1: AIã®æ„å›³èª¬æ˜ -->
                    <button onclick="explainAIDecision()" class="ai-button">
                        âœ¨ AIã®æ„å›³ã‚’èª¬æ˜
                    </button>
                </div>
                
                <!-- ã‚³ãƒãƒ³ãƒ‰ãƒ­ã‚° -->
                <div id="commandLog" class="status-box status-neutral">
                    <div class="flex justify-between items-center mb-1">
                        <span class="status-icon">â–¶</span> Command Log
                         <!-- Gemini æ©Ÿèƒ½ 2: é‹è¡Œãƒ­ã‚°ã‚µãƒãƒªãƒ¼ -->
                        <button onclick="summarizeRunLog()" class="ai-button">
                            âœ¨ é‹è¡Œãƒ­ã‚°ã‚µãƒãƒªãƒ¼ã‚’ä½œæˆ
                        </button>
                    </div>
                    <div class="command-log-content" id="logContent">
                        -
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œ/èµ·å‹•ãƒœã‚¿ãƒ³ -->
        <div class="p-5 border-t border-gray-700">
            <h2 class="text-lg font-semibold mb-3 text-cyan-400">æ“ä½œ/èµ·å‹•</h2>
            <div class="flex space-x-2">
                 <!-- èµ·å‹•ãƒœã‚¿ãƒ³ -->
                <button id="startCameraButton" class="control-button bg-green-500 hover:bg-green-600 flex-grow">ã‚«ãƒ¡ãƒ©/ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•</button>
                <!-- ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ -->
                <button onclick="showHelpModal()" class="control-button bg-indigo-500 hover:bg-indigo-600 flex-shrink-0 w-24">ãƒ˜ãƒ«ãƒ— ğŸ’¡</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ******************************************************
    // I. Gemini API è¨­å®šã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ******************************************************
    const API_KEY = ""; // Canvasç’°å¢ƒã§è‡ªå‹•çš„ã«æä¾›ã•ã‚Œã¾ã™
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
    
    let isModalVisible = false;

    function showModal(title, content, isHtml = false) {
        document.getElementById('modalTitle').textContent = title;
        const modalBody = document.getElementById('modalBody');
        if (isHtml) {
            modalBody.innerHTML = content;
            modalBody.className = 'text-sm leading-relaxed'; 
        } else {
            modalBody.textContent = content;
            modalBody.className = 'whitespace-pre-wrap text-sm leading-relaxed'; 
        }
        document.getElementById('geminiModal').style.display = 'flex';
        isModalVisible = true;
    }

    function hideModal() {
        document.getElementById('geminiModal').style.display = 'none';
        isModalVisible = false;
    }
    
    async function callGeminiAPI(systemPrompt, userQuery, maxRetries = 3) {
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.status === 429 && attempt < maxRetries - 1) {
                    const delay = Math.pow(2, attempt) * 1000; // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue; // Retry
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content?.parts?.[0]?.text) {
                    return result.candidates[0].content.parts[0].text;
                } else if (result.error) {
                    throw new Error(`API Error: ${result.error.message}`);
                } else {
                    throw new Error("API response was empty or malformed.");
                }

            } catch (error) {
                if (attempt === maxRetries - 1) {
                    console.error("Gemini API call failed after multiple retries:", error);
                    throw new Error("APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
                }
            }
        }
    }


    // ******************************************************
    // II. ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®šã¨çŠ¶æ…‹å¤‰æ•°
    // ******************************************************
    let arduinoState = 'WAIT_START'; 
    let isAiActive = false; 
    let aiLoopInterval = null;
    const UPDATE_INTERVAL_MS = 1000;
    const CAMERA_WIDTH = 640;
    const CAMERA_HEIGHT = 480;

    let aiCanvas = null;
    let aiCtx = null;
    let videoElement = null;
    let isProcessing = false;
    let tempCanvas = null;
    
    let currentManualCommand = null;
    let lastAiDecision = { command: 'STOP', reason: 'åˆæœŸçŠ¶æ…‹', detections: null };


    // ******************************************************
    // III. Bluetoothé€šä¿¡ã®ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    // ******************************************************
    class BluetoothEmulator {
        constructor() {
            this.apiUrl = "https://your-arduino-bluetooth-endpoint.com/command"; 
            this.isConnected = false;
            this.logEntries = []; // ãƒ­ã‚°ã‚¨ãƒ³ãƒˆãƒªã‚’ä¿æŒã™ã‚‹é…åˆ—
        }
        async connect() {
            this.isConnected = true;
            this.log('Bluetooth: æ¥ç¶šæˆåŠŸã€‚Arduinoã‹ã‚‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¾…æ©Ÿä¸­ã€‚', 'info');
        }
        async sendCommand(command) {
            if (!this.isConnected) {
                this.log(`Bluetooth: æœªæ¥ç¶šã®ãŸã‚ã‚³ãƒãƒ³ãƒ‰[${command}]ã‚’é€ä¿¡ã§ãã¾ã›ã‚“ã€‚`, 'error');
                return;
            }
            this.log(`TX: ${command}`, command === 'STOP' ? 'info' : 'success');
        }
        log(message, type = 'info') {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const logItem = { time: timeString, message: message, type: type, timestamp: now.getTime() };
            
            this.logEntries.unshift(logItem); // é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
            
            // UIæ›´æ–°
            const logElement = document.getElementById('logContent');
            if (!logElement) { console.log(message); return; } 
            
            let colorClass = 'log-info';
            if (type === 'error') colorClass = 'log-error';
            if (type === 'success') colorClass = 'log-success';

            const formattedMessage = `<span class="${colorClass} command-log-item">[${timeString}] ${message}</span>`;
            
            // æœ€æ–°10ä»¶ã ã‘UIã«è¡¨ç¤º
            logElement.innerHTML = this.logEntries.slice(0, 10).map(entry => {
                let uiColor = 'log-info';
                if (entry.type === 'error') uiColor = 'log-error';
                if (entry.type === 'success') uiColor = 'log-success';
                return `<span class="${uiColor} command-log-item">[${entry.time}] ${entry.message}</span>`;
            }).join('');
            
            logElement.scrollTop = 0;
        }
    }
    const btEmulator = new BluetoothEmulator();


    // ******************************************************
    // IV. AIåˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯ (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
    // ******************************************************
    function captureFrameAsBase64() {
        if (!tempCanvas) { tempCanvas = document.createElement('canvas'); }
        tempCanvas.width = videoElement.videoWidth;
        tempCanvas.height = videoElement.videoHeight;
        const ctx = tempCanvas.getContext('2d');
        ctx.drawImage(videoElement, 0, 0, tempCanvas.width, tempCanvas.height);
        return tempCanvas.toDataURL('image/jpeg', 0.8).split(',')[1];
    }

    async function analyzeFrame(base64Image) {
        const decisionTextElement = document.getElementById('aiDecisionText');
        await new Promise(resolve => setTimeout(resolve, 500)); 
        
        const obstacleChance = Math.floor(Math.random() * 100);
        let command = 'FORWARD';
        const detections = [];
        let primaryDetection = null;
        let decisionReason = "è¦–é‡å†…ã«å±é™ºãªéšœå®³ç‰©ã‚„è¿½è·¡å¯¾è±¡ãŒãªã„ãŸã‚ã€ç›´é€²ã‚’ç¶™ç¶šã—ã¾ã™ã€‚";

        if (obstacleChance < 60) {
            let x_center, decision;

            if (obstacleChance < 20) { 
                x_center = 0.20;
                command = 'TURN_R';
                decision = "âš  ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆå·¦ï¼‰: å³ã¸å›é¿ï¼†è¿½å°¾ä¸­";
                decisionReason = "æ¤œå‡ºã•ã‚ŒãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆéšœå®³ç‰©ï¼‰ãŒç”»é¢ã®å·¦ç«¯ã«ä½ç½®ã—ã¦ã„ã‚‹ãŸã‚ã€è¡çªã‚’é¿ã‘ã‚‹ãŸã‚ã«å³æ—‹å›ï¼ˆTURN_Rï¼‰ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚åŒæ™‚ã«ã‚«ãƒ¡ãƒ©ã‚‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã‚ºãƒ¼ãƒ ã—ã¦ã„ã¾ã™ã€‚";
            } else if (obstacleChance < 40) {
                x_center = 0.80;
                command = 'TURN_L';
                decision = "âš  ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆå³ï¼‰: å·¦ã¸å›é¿ï¼†è¿½å°¾ä¸­";
                decisionReason = "æ¤œå‡ºã•ã‚ŒãŸã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆéšœå®³ç‰©ï¼‰ãŒç”»é¢ã®å³ç«¯ã«ä½ç½®ã—ã¦ã„ã‚‹ãŸã‚ã€è¡çªã‚’é¿ã‘ã‚‹ãŸã‚ã«å·¦æ—‹å›ï¼ˆTURN_Lï¼‰ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚åŒæ™‚ã«ã‚«ãƒ¡ãƒ©ã‚‚ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã‚ºãƒ¼ãƒ ã—ã¦ã„ã¾ã™ã€‚";
            } else { 
                x_center = 0.50;
                command = 'FORWARD'; 
                decision = "âš  ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆä¸­å¤®ï¼‰: ç›´é€²ç¶™ç¶šï¼†è¿½å°¾ä¸­";
                decisionReason = "ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒä¸­å¤®ã«æ‰ãˆã‚‰ã‚Œã¦ãŠã‚Šã€é©æ­£ãªè·é›¢ã‚’ä¿ã¦ã¦ã„ã‚‹ãŸã‚ã€ç›´é€²ï¼ˆFORWARDï¼‰ã‚’ç¶™ç¶šã—ã¾ã™ã€‚";
            }
            
            primaryDetection = { x: x_center, y: 0.7, w: 0.2, h: 0.3, label: 'Tracking Target' };
            detections.push(primaryDetection);
            decisionTextElement.textContent = decision;
            document.getElementById('decisionOutput') && (document.getElementById('decisionOutput').style.color = '#FF4136');
            
        } else {
            command = 'FORWARD';
            decisionTextElement.textContent = "âœ… å®‰å…¨èµ°è¡Œ: è‡ªå‹•è¿½å°¾åœæ­¢";
            document.getElementById('decisionOutput') && (document.getElementById('decisionOutput').style.color = '#66ffcc');
        }
        
        // AIã®æœ€çµ‚æ±ºå®šã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
        lastAiDecision = { command, reason: decisionReason, detections, timestamp: new Date().getTime() };

        return { command, detections, primaryDetection };
    }

    // ******************************************************
    // V. Gemini LLM é€£æºæ©Ÿèƒ½
    // ******************************************************

    async function explainAIDecision() {
        if (!isCameraInitialized) {
            showModal("ã‚¨ãƒ©ãƒ¼", "ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚", false);
            return;
        }
        
        showModal("âœ¨ AIã®æ„å›³èª¬æ˜ (Geminiå‡¦ç†ä¸­...)", "åˆ†æä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...", false);

        const { command, reason, timestamp } = lastAiDecision;
        const formattedTimestamp = new Date(timestamp).toLocaleTimeString();
        
        const systemPrompt = "ã‚ãªãŸã¯è‡ªå¾‹èµ°è¡Œè»Šã®AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã€AIãŒç›´å‰ã«ä¸‹ã—ãŸé‹è»¢åˆ¤æ–­ã®ç†ç”±ã‚’ã€æŠ€è¡“çš„ãªå†…å®¹ã‚’å«ã‚ãšã«ã€è¦ªåˆ‡ã§åˆ†ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã§ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚";
        
        const userQuery = `ç¾åœ¨ã®Arduinoã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯'${arduinoState}'ã§ã™ã€‚AIãŒ${formattedTimestamp}ã«é€ä¿¡ã—ãŸæœ€æ–°ã®ã‚³ãƒãƒ³ãƒ‰ã¯'${command}'ã§ã€ãã®å†…éƒ¨çš„ãªåˆ¤æ–­ç†ç”±ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚\n\nåˆ¤æ–­ç†ç”±: ${reason}\n\nã“ã®æƒ…å ±ã‚’åŸºã«ã€ãªãœAIãŒãã®è¡Œå‹•ã‚’é¸ã‚“ã ã®ã‹èª¬æ˜ã—ã¦ãã ã•ã„ã€‚`;

        try {
            const explanation = await callGeminiAPI(systemPrompt, userQuery);
            showModal("âœ¨ AIã®æ„å›³èª¬æ˜ - æœ€æ–°ã®åˆ¤æ–­", explanation, false);
        } catch (error) {
            showModal("ã‚¨ãƒ©ãƒ¼", error.message, false);
        }
    }

    async function summarizeRunLog() {
        if (btEmulator.logEntries.length === 0) {
            showModal("ã‚¨ãƒ©ãƒ¼", "ãƒ­ã‚°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ã‚’ç¨¼åƒã•ã›ã¦ãã ã•ã„ã€‚", false);
            return;
        }

        showModal("âœ¨ é‹è¡Œãƒ­ã‚°ã‚µãƒãƒªãƒ¼ (Geminiå‡¦ç†ä¸­...)", "ãƒ­ã‚°ã‚’åˆ†æã—ã€ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...", false);

        const logText = btEmulator.logEntries.map(e => `[${e.time}] [${e.type.toUpperCase()}] ${e.message}`).reverse().join('\n');
        
        const systemPrompt = "ã‚ãªãŸã¯é‹è¡Œç®¡ç†ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã™ã€‚æä¾›ã•ã‚ŒãŸé‹è¡Œãƒ­ã‚°ã‚’åˆ†æã—ã€ä»¥ä¸‹ã®æ§‹é€ ã§ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚1. é‹è¡Œæ¦‚è¦ï¼ˆé–‹å§‹/å®Œäº†æ™‚åˆ»ã€AIåˆ¶å¾¡ã¨æ‰‹å‹•æ“ä½œã®æ¦‚ç®—æ¯”ç‡ï¼‰ã€‚2. ç‰¹ç­†ã™ã¹ãã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¨ãƒ©ãƒ¼ã€ä¸€æ™‚åœæ­¢ã€ä¸»è¦ãªAIã®åˆ‡ã‚Šæ›¿ãˆï¼‰ã€‚3. æ¬¡ã®é‹è¡Œã«å‘ã‘ãŸç°¡å˜ãªæ”¹å–„ææ¡ˆã€‚ãƒ¬ãƒãƒ¼ãƒˆã¯æ—¥æœ¬èªã§ã€å°‚é–€çš„ã™ããªã„ãƒˆãƒ¼ãƒ³ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚";
        
        const userQuery = `é‹è¡Œãƒ­ã‚°å…¨ä½“ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™:\n\n${logText}\n\nä¸Šè¨˜ã®ãƒ­ã‚°ã«åŸºã¥ã„ã¦ãƒ¬ãƒãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`;

        try {
            const summary = await callGeminiAPI(systemPrompt, userQuery);
            showModal("âœ¨ é‹è¡Œãƒ­ã‚°ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ", summary, false);
        } catch (error) {
            showModal("ã‚¨ãƒ©ãƒ¼", error.message, false);
        }
    }
    
    // ******************************************************
    // VI. ãƒ˜ãƒ«ãƒ—/è£œè¶³æƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ«
    // ******************************************************
    function showHelpModal() {
        // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¨ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ—æƒ…å ±ã‚’å®šç¾©
        const helpContent = `
            <div class="help-section">
                <h3>ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦</h3>
                <p>ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã‚«ãƒ¡ãƒ©ã‚’åˆ©ç”¨ã—éšœå®³ç‰©ã‚’æ¤œçŸ¥ã—ã€æ¤œçŸ¥çµæœã«åŸºã¥ã„ã¦å›é¿æ–¹æ³•ã‚’Arduinoã«é€ä¿¡ã™ã‚‹ãƒ‡ãƒ¢ã§ã™ã€‚</p>
                <p>æ‰‹å‹•ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ç”»é¢ä¸Šã®ã‚«ãƒ¡ãƒ©æ˜ åƒã‚¨ãƒªã‚¢ã®ä¸‹éƒ¨3åˆ†ã®2ã®ã‚¨ãƒªã‚¢ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§éšœå®³ç‰©ã‚’å›é¿ã™ã‚‹æ“ä½œãŒå¯èƒ½ã§ã™ã€‚</p>
            </div>
            <div class="help-section">
                <h3>æ“ä½œæ‰‹é †</h3>
                <ol class="list-decimal list-inside ml-2">
                    <li>ã€Œã‚«ãƒ¡ãƒ©/ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã€ã‚«ãƒ¡ãƒ©ã¨ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•ã—ã¾ã™ã€‚</li>
                    <li><strong>WAIT_START</strong> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®é–“ã¯æ“ä½œå¾…æ©Ÿä¸­ã§ã™ã€‚</li>
                    <li>ãƒ‡ãƒ¢ç”¨æ©Ÿèƒ½: ` + '`simulateArduinoPieceAction(\'place_piece\')`' + `ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã¨ DRIVING çŠ¶æ…‹ã«ç§»è¡Œã—ã¾ã™ã€‚</li>
                    <li>DRIVING çŠ¶æ…‹ã«ãªã‚‹ã¨éšœå®³ç‰©æ¤œçŸ¥ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚</li>
                </ol>
            </div>
            <div class="help-section">
                <h3>Arduinoã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¨æ„å‘³</h3>
                <ul class="list-disc list-inside ml-2">
                    <li><strong>WAIT_START</strong>: ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•æ¸ˆã¿ã€‚é‡‘å±ãƒ”ãƒ¼ã‚¹è¨­ç½®ã‚’å¾…æ©Ÿä¸­ã€‚</li>
                    <li><strong>DRIVING</strong>: äº‹å‰ã«æŒ‡å®šã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«å¾“ã„è‡ªå¾‹èµ°è¡Œã—ã¾ã™ã€‚ã¾ãŸã€éšœå®³ç‰©ã‚’æ¤œçŸ¥ã—ã€å›é¿æ–¹æ³•ã‚’Arduinoã«é€ä¿¡ã—ã¾ã™ã€‚</li>
                    <li><strong>PAUSE</strong>: ãƒ”ãƒ¼ã‚¹å–ã‚Šå¤–ã—ãªã©ã«ã‚ˆã‚Šä¸€æ™‚åœæ­¢ã€‚</li>
                    <li><strong>COMPLETE</strong>: èª²é¡Œå®Œäº†ã€‚AIåˆ¶å¾¡ã¯åœæ­¢ã€‚</li>
                </ul>
            </div>
            <div class="help-section">
                <h3>Gemini AI é€£æºæ©Ÿèƒ½</h3>
                <ul class="list-disc list-inside ml-2">
                ã€€ã€€<li><strong>æ³¨æ„ç‚¹</strong>: æœ¬æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã«ã¯ã€Gemini APIã‚­ãƒ¼ã‚’äº‹å‰ã«ä¿æœ‰ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</li>
                    <li><strong>AIã®æ„å›³ã‚’èª¬æ˜</strong>: éšœå®³ç‰©æ¤œçŸ¥çµæœãƒ»å›é¿æ–¹æ³•ã«ã¤ã„ã¦GeminiãŒè§£èª¬ã—ã¾ã™ã€‚</li>
                    <li><strong>é‹è¡Œãƒ­ã‚°ã®ä½œæˆ</strong>: è¨˜éŒ²ã•ã‚ŒãŸã‚³ãƒãƒ³ãƒ‰ãƒ­ã‚°ã‚’GeminiãŒåˆ†æã—ã€é‹è¡Œå…¨ä½“ã®ãƒ­ã‚°ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</li>
                </ul>
            </div>
        `;
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        showModal("ğŸ’¡ ãƒ˜ãƒ«ãƒ—ã¨è£œè¶³æƒ…å ±", helpContent, true);
    }


    // ******************************************************
    // VII. æç”»ã€è¿½å°¾ã€åˆ¶å¾¡ãƒ«ãƒ¼ãƒ— (æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯)
    // ******************************************************

    function drawDetections(detections) {
        if (!aiCtx || !aiCanvas) return;
        aiCtx.clearRect(0, 0, aiCanvas.width, aiCanvas.height);
        const cw = aiCanvas.width;
        const ch = aiCanvas.height;
        detections.forEach(det => {
            const x = det.x * cw - (det.w * cw / 2);
            const y = det.y * ch - (det.h * ch / 2);
            const w = det.w * cw;
            const h = det.h * ch;
            aiCtx.strokeStyle = '#00ffff'; aiCtx.lineWidth = 3; aiCtx.strokeRect(x, y, w, h);
            aiCtx.fillStyle = '#00ffff'; aiCtx.font = 'bold 16px Montserrat'; 
            aiCtx.fillText(det.label, x + 5, y + 20);
        });
    }

    function updateCameraTracking(targetDetection) {
        const elements = [videoElement, aiCanvas];
        if (!targetDetection) {
            elements.forEach(el => { el.style.transform = `scale(1.0) translate(0, 0)`; });
            return;
        }
        const TARGET_SCALE = 1.3; 
        const targetX = targetDetection.x;
        const targetY = targetDetection.y;
        const dx = 0.5 - targetX;
        const dy = 0.5 - targetY;
        const translateX = dx * 100 * TARGET_SCALE;
        const translateY = dy * 100 * TARGET_SCALE;
        elements.forEach(el => {
            el.style.transform = `scale(${TARGET_SCALE}) translate(${translateX}%, ${translateY}%)`;
        });
        btEmulator.log(`DPTZ: è¿½å°¾ (${targetDetection.label}) -> ç§»å‹• X:${translateX.toFixed(1)}% Y:${translateY.toFixed(1)}%`, 'info');
    }

    async function aiControlLoop() {
        // AIãƒ¢ãƒ¼ãƒ‰ã§ã¯ãªã„ã€ã¾ãŸã¯ä»–ã®å‡¦ç†ãŒå®Ÿè¡Œä¸­ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (arduinoState !== 'DRIVING' || isProcessing || isModalVisible) {
             if (arduinoState !== 'DRIVING') {
                 if (aiCtx && aiCanvas) { aiCtx.clearRect(0, 0, aiCanvas.width, aiCanvas.height); }
                 updateCameraTracking(null);
             }
             return;
        }

        isProcessing = true; 
        
        try {
            const base64Image = captureFrameAsBase64();
            const { command, detections, primaryDetection } = await analyzeFrame(base64Image); 
            
            btEmulator.sendCommand(command);
            
            document.getElementById('decisionOutput') && (document.getElementById('decisionOutput').firstChild.nodeValue = 'âš¡ AI Decision: ' + command + ' ');

            drawDetections(detections);
            updateCameraTracking(primaryDetection);

        } catch (error) {
            btEmulator.log(`AI Processing Error: ${error.message}`, 'error');
        } finally {
            isProcessing = false; 
        }
    }


    // ******************************************************
    // VIII. ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã¨æ‰‹å‹•æ“ä½œ
    // ******************************************************
    
    let isCameraInitialized = false;

    function adjustCanvasSize() {
        const viewport = document.getElementById('viewport');
        aiCanvas.width = viewport.clientWidth;
        aiCanvas.height = viewport.clientHeight;
        window.addEventListener('resize', () => {
             aiCanvas.width = viewport.clientWidth;
             aiCanvas.height = viewport.clientHeight;
        });
    }

    async function startCamera() {
        if (isCameraInitialized) return;

        videoElement = document.getElementById('cameraFeed');
        aiCanvas = document.getElementById('aiCanvas');
        aiCtx = aiCanvas.getContext('2d');
        
        try {
            // ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: CAMERA_WIDTH, height: CAMERA_HEIGHT, facingMode: 'environment' } 
            });
            videoElement.srcObject = stream;
            
            videoElement.onloadedmetadata = async () => {
                adjustCanvasSize();

                const tracks = stream.getVideoTracks();
                if (tracks.length > 0) {
                    const track = tracks[0];
                    let afSuccess = false;

                    const settings = track.getSettings();
                    // ãƒ•ãƒ­ãƒ³ãƒˆã‚«ãƒ¡ãƒ©ã®å ´åˆã€æ˜ åƒã‚’åè»¢ã•ã›ã‚‹ (èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’æƒ³å®šã—ã¦ã„ã‚‹ãŸã‚)
                    if (settings.facingMode === 'user' || settings.facingMode === 'left') {
                         videoElement.style.transform = 'scaleX(-1)'; 
                    } else {
                         videoElement.style.transform = 'scaleX(1)';
                    }
                    
                    try {
                        // ã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹è¨­å®š
                        const capabilities = track.getCapabilities();
                        if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                            await track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
                            afSuccess = true;
                        } 
                    } catch (e) {
                         console.error("AFè¨­å®šè©¦è¡Œã‚¨ãƒ©ãƒ¼:", e);
                    }

                    if (afSuccess) {
                        btEmulator.log('Camera: é€£ç¶šã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸã€‚', 'info');
                    } else {
                        btEmulator.log('Camera: é€£ç¶šAFã¯éå¯¾å¿œã¾ãŸã¯è¨­å®šå¤±æ•—ã€‚ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³ã§å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'info');
                    }
                }

                btEmulator.connect(); 
                aiLoopInterval = setInterval(aiControlLoop, UPDATE_INTERVAL_MS);
                isCameraInitialized = true;
                document.getElementById('aiDecisionText').textContent = "AIç›£è¦–ä¸­...";
                document.getElementById('startCameraButton').textContent = "ã‚·ã‚¹ãƒ†ãƒ ç¨¼åƒä¸­";
                document.getElementById('startCameraButton').disabled = true;
                setupTouchControls(); // ã‚¿ãƒƒãƒæ“ä½œã‚’æœ‰åŠ¹åŒ–
            };
        } catch (err) {
            document.getElementById('aiDecisionText').textContent = "âš  ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: HTTPSç’°å¢ƒã¨æ¨©é™ãŒå¿…è¦ã§ã™";
            btEmulator.log(`Camera Error: ${err.message}`, 'error');
        }
    }

    function sendManualCommand(command) {
        if (arduinoState === 'DRIVING') {
            btEmulator.log("AIåˆ¶å¾¡ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä¸­ã€‚æ‰‹å‹•æ“ä½œã¯ç„¡åŠ¹ã§ã™ã€‚", 'error');
            return;
        }
        
        if (command === currentManualCommand) return; 
        
        if (command !== 'STOP') {
            btEmulator.sendCommand(command);
            currentManualCommand = command;
            document.getElementById('decisionOutput') && (document.getElementById('decisionOutput').firstChild.nodeValue = 'âš¡ Manual Control: ' + command + ' ');
        } else {
            btEmulator.sendCommand('STOP');
            currentManualCommand = null;
            document.getElementById('decisionOutput') && (document.getElementById('decisionOutput').firstChild.nodeValue = 'âš¡ Manual Control: STOP ');
        }
    }

    function setupTouchControls() {
        const overlay = document.getElementById('touchControlOverlay');
        const touchZones = overlay.querySelectorAll('.touch-zone[data-command]');
        
        const startTouch = (e) => {
            if (arduinoState === 'DRIVING') {
                btEmulator.log("AIåˆ¶å¾¡ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä¸­ã€‚æ‰‹å‹•æ“ä½œã¯ç„¡åŠ¹ã§ã™ã€‚", 'error');
                return;
            }
            e.preventDefault();
            const targetZone = e.currentTarget;
            const command = targetZone.getAttribute('data-command');

            if (command && command !== currentManualCommand) {
                 sendManualCommand(command);
                 targetZone.classList.add('active');
            }
        };

        const endTouch = (e) => {
            if (arduinoState === 'DRIVING' || !currentManualCommand) return;
            e.preventDefault();
            
            sendManualCommand('STOP');
            document.querySelectorAll('.touch-zone.active').forEach(el => el.classList.remove('active'));
        };

        touchZones.forEach(zone => {
            // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
            zone.addEventListener('touchstart', startTouch, { passive: false });
            zone.addEventListener('touchend', endTouch, { passive: false });
            zone.addEventListener('touchcancel', endTouch, { passive: false }); 
            // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ (PCã‹ã‚‰ã®æ“ä½œç”¨)
            zone.addEventListener('mousedown', startTouch);
            zone.addEventListener('mouseup', endTouch);
            zone.addEventListener('mouseleave', endTouch);
        });
        
        btEmulator.log("Manual Control: ã‚¿ãƒƒãƒæ“ä½œã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸã€‚", 'info');
    }
    
    // èµ·å‹•ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    document.getElementById('startCameraButton') && document.getElementById('startCameraButton').addEventListener('click', startCamera);

    // ******************************************************
    // IX. ç™ºè¡¨ãƒ‡ãƒ¢ç”¨ï¼šArduinoã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰åŒ–ã®æ¨¡æ“¬
    // ******************************************************

    window.simulateArduinoPieceAction = function(action) {
        switch (action) {
            case 'place_piece':
                if (arduinoState === 'WAIT_START' || arduinoState === 'PAUSE') { receiveStatus('DRIVING_START'); } 
                break;
            case 'remove_piece':
                if (arduinoState === 'DRIVING') { receiveStatus('PAUSE_TRIPPED'); } 
                else if (arduinoState === 'COMPLETE') { receiveStatus('SEQUENCE_RESET'); }
                break;
            case 'complete_sequence':
                 if (arduinoState === 'DRIVING') { receiveStatus('SEQUENCE_COMPLETE'); }
                 break;
        }
        btEmulator.log(`SIMULATED: Arduino Status Change: ${arduinoState}`, 'info');
    };
    
    // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã®åˆæœŸãƒ­ã‚°
    setTimeout(() => {
        btEmulator.log("ãƒ‡ãƒ¢æº–å‚™å®Œäº†: é‡‘å±ãƒ”ãƒ¼ã‚¹ã‚’ç½®ã„ã¦ãã ã•ã„ (DRIVING_START)", 'info');
    }, 500);
    
    function receiveStatus(status) {
        let stateText;
        let stateClass;
        
        switch (status) {
            case 'DRIVING_START':
            case 'DRIVING_RESUMED':
                arduinoState = 'DRIVING';
                stateText = 'DRIVING (éšœå®³ç‰©æ¤œçŸ¥æ©Ÿèƒ½èµ·å‹•ä¸­)';
                stateClass = 'status-driving';
                break;
            case 'PAUSE_TRIPPED':
                arduinoState = 'PAUSE';
                stateText = 'PAUSE (ä¸€æ™‚åœæ­¢ä¸­)';
                stateClass = 'status-pause';
                updateCameraTracking(null); 
                break;
            case 'SEQUENCE_COMPLETE':
                arduinoState = 'COMPLETE';
                stateText = 'COMPLETE (èª²é¡Œå®Œäº†)';
                stateClass = 'status-complete';
                updateCameraTracking(null); 
                break;
            default:
                arduinoState = 'WAIT_START';
                stateText = 'WAIT_START (å¾…æ©Ÿä¸­)';
                stateClass = 'status-wait';
                btEmulator.log(`ERROR: Unknown status received or reset to WAIT_START: ${status}`, 'error');
                break;
        }
        
        const statusElement = document.getElementById('arduinoStatus');
        if (statusElement) {
            statusElement.textContent = `Arduino State: ${stateText}`;
            statusElement.className = `status-box ${stateClass}`; 
        }
    }

</script>
</body>
</html>

